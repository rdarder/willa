{"version":3,"file":"drive-controls.js","sourceRoot":"","sources":["../src/drive-controls.ts"],"names":[],"mappings":";;AAAA,OAAO,KAAK,WAAW,MAAM,aAAa,CAAC;AAC3C,OAAO,EAAE,UAAU,EAAkB,GAAG,EAAE,IAAI,EAAE,MAAM,KAAK,CAAC;AAC5D,OAAO,EAAE,aAAa,EAAE,QAAQ,EAAE,KAAK,EAAE,MAAM,mBAAmB,CAAC;AAEnE,OAAO,EAAE,KAAK,EAAE,MAAM,iBAAiB,CAAC;AACxC,OAAO,EAAgB,SAAS,EAAE,MAAM,SAAS,CAAC;AAElD,OAAO,SAAS,CAAC;AACjB,OAAO,YAAY,CAAC;AACpB,OAAO,SAAS,CAAC;AACjB,OAAO,QAAQ,MAAM,YAAY,CAAC;AAClC,OAAO,EAAc,SAAS,EAAE,WAAW,EAAE,MAAM,SAAS,CAAC;AAW7D,MAAM,OAAO,kBAAkB;IAA/B;QACU,qBAAgB,GAAkB,IAAI,CAAC;QACvC,cAAS,GAAqB,IAAI,CAAC;QACnC,YAAO,GAAiB;YAC9B,KAAK,EAAE,CAAC;YACR,UAAU,EAAE,KAAK,CAAC,eAAe,CAAC,SAAS,CAAC,IAAI;YAChD,WAAW,EAAE,CAAC;YACd,YAAY,EAAE,CAAC;YACf,WAAW,EAAE,CAAC;YACd,IAAI,EAAE,CAAC;SACR,CAAC;QA8CM,gBAAW,GAAG,GAAS,EAAE;YAC/B,IAAI,IAAI,CAAC,SAAS,KAAK,IAAI,EAAE;gBAC3B,MAAM,IAAI,KAAK,CAAC,cAAc,CAAC,CAAC;aACjC;YACD,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,IAAI,CAAC,gBAAgB,EAAE,CAAC,CAAC;QAC/C,CAAC,CAAC;IACJ,CAAC;IAlDC,MAAM,CAAC,SAAoB;QACzB,IAAI,CAAC,SAAS,GAAG,SAAS,CAAC;QAC3B,IAAI,CAAC,OAAO,EAAE,CAAC;QACf,IAAI,CAAC,gBAAgB,GAAG,MAAM,CAAC,WAAW,CACxC,IAAI,CAAC,WAAW,EAChB,QAAQ,CAAC,yBAAyB,CACnC,CAAC;IACJ,CAAC;IAED,OAAO;QACL,IAAI,IAAI,CAAC,gBAAgB,KAAK,IAAI,EAAE;YAClC,YAAY,CAAC,IAAI,CAAC,gBAAiB,CAAC,CAAC;SACtC;IACH,CAAC;IACD,aAAa,CAAC,OAAqB;QACjC,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC;IACzB,CAAC;IAEO,gBAAgB;QACtB,MAAM,OAAO,GAAG,IAAI,WAAW,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC;QAC7C,KAAK,CAAC,eAAe,CAAC,YAAY,CAAC,iBAAiB,CAAC,OAAO,CAAC,CAAC;QAC9D,KAAK,CAAC,eAAe,CAAC,YAAY,CAAC,QAAQ,CAAC,OAAO,EAAE,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC;QACzE,KAAK,CAAC,eAAe,CAAC,YAAY,CAAC,YAAY,CAC7C,OAAO,EACP,IAAI,CAAC,OAAO,CAAC,UAAU,CACxB,CAAC;QACF,KAAK,CAAC,eAAe,CAAC,YAAY,CAAC,aAAa,CAC9C,OAAO,EACP,IAAI,CAAC,OAAO,CAAC,WAAW,CACzB,CAAC;QACF,KAAK,CAAC,eAAe,CAAC,YAAY,CAAC,cAAc,CAC/C,OAAO,EACP,IAAI,CAAC,OAAO,CAAC,YAAY,CAC1B,CAAC;QACF,KAAK,CAAC,eAAe,CAAC,YAAY,CAAC,aAAa,CAC9C,OAAO,EACP,IAAI,CAAC,OAAO,CAAC,WAAW,CACzB,CAAC;QACF,KAAK,CAAC,eAAe,CAAC,YAAY,CAAC,OAAO,CAAC,OAAO,EAAE,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;QACvE,MAAM,MAAM,GAAG,KAAK,CAAC,eAAe,CAAC,YAAY,CAAC,eAAe,CAAC,OAAO,CAAC,CAAC;QAC3E,OAAO,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC;QACvB,OAAO,OAAO,CAAC,YAAY,EAAE,CAAC;IAChC,CAAC;CAQF;AASM,IAAM,aAAa,qBAAnB,MAAM,aAAc,SAAQ,UAAU;IAAtC;;QAEL,cAAS,GAAqB,IAAI,CAAC;QAG3B,aAAQ,GAAW,CAAC,CAAC;QAGrB,iBAAY,GAAiB,EAAE,IAAI,EAAE,SAAS,CAAC,IAAI,EAAE,KAAK,EAAE,CAAC,EAAE,CAAC;QAGhE,eAAU,GAAe;YAC/B,MAAM,EAAE,WAAW,CAAC,GAAG;YACvB,IAAI,EAAE,KAAK;YACX,IAAI,EAAE,SAAS,CAAC,QAAQ;SACzB,CAAC;QAEM,UAAK,GAAY,KAAK,CAAC;QAEvB,kBAAa,GAAG,IAAI,kBAAkB,EAAE,CAAC;IA6JnD,CAAC;IA3JC,MAAM,KAAK,MAAM;QACf,OAAO,GAAG,CAAA;;;;;;;;;;;;;;;;;;;KAmBT,CAAC;IACJ,CAAC;IAED,oBAAoB;QAClB,KAAK,CAAC,oBAAoB,EAAE,CAAC;QAC7B,IAAI,CAAC,aAAa,CAAC,OAAO,EAAE,CAAC;IAC/B,CAAC;IAED,UAAU,CAAC,iBAAuC;QAChD,IAAI,iBAAiB,CAAC,GAAG,CAAC,WAAW,CAAC,EAAE;YACtC,IAAI,CAAC,aAAa,CAAC,OAAO,EAAE,CAAC;YAC7B,IAAI,IAAI,CAAC,SAAS,KAAK,IAAI,EAAE;gBAC3B,IAAI,CAAC,aAAa,CAAC,MAAM,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;aAC3C;SACF;IACH,CAAC;IAEO,UAAU;QAChB,MAAM,SAAS,GAAG,IAAI,CAAC,UAAU,EAAE,CAAC;QACpC,IAAI,IAAI,CAAC,KAAK,EAAE;YACd,OAAO,IAAI,CAAA;;eAEF,IAAI,CAAC,YAAY,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,KAAK,SAAS,CAAC,WAAW;mBACxD,IAAI,CAAC,YAAY,CAAC,IAAI,KAAK,SAAS,CAAC,UAAU;YACtD,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC,CAAC,KAAK,SAAS,CAAC,KAAK;UAC9C,IAAI,CAAC,UAAU;iBACd,MAAM,KAAK,SAAS,CAAC,YAAY,MAAM,SAAS,CAAC,WAAW;QAC/D,IAAI,CAAC,UAAU,CAAC,IAAI,KAAK,SAAS,CAAC,IAAI;cACjC,SAAS,CAAC,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC;;QAErC,CAAC;SACJ;aAAM;YACL,OAAO,IAAI,CAAC;SACb;IACH,CAAC;IAED,MAAM;QACJ,OAAO,IAAI,CAAA;;UAEL,IAAI,CAAC,UAAU,EAAE;;qBAEN,IAAI,CAAC,QAAQ;oBACd,IAAI,CAAC,gBAAgB;;;mBAGtB,IAAI,CAAC,KAAK;oBACT,IAAI,CAAC,aAAa;yBACb,IAAI,CAAC,WAAW;;;;;mBAKtB,IAAI,CAAC,YAAY;kBAClB,IAAI,CAAC,oBAAoB;;KAEtC,CAAC;IACJ,CAAC;IACO,aAAa,CAAC,KAA8B;QAClD,IAAI,CAAC,UAAU,GAAG,KAAK,CAAC,MAAoB,CAAC;QAC7C,IAAI,CAAC,aAAa,EAAE,CAAC;IACvB,CAAC;IAEO,gBAAgB,CAAC,KAAkC;QACzD,IAAI,CAAC,QAAQ,GAAI,KAAK,CAAC,MAAyB,CAAC,QAAQ,CAAC;QAC1D,IAAI,CAAC,aAAa,EAAE,CAAC;IACvB,CAAC;IACO,oBAAoB,CAAC,KAAgC;QAC3D,IAAI,CAAC,YAAY,GAAG,KAAK,CAAC,MAAsB,CAAC;QACjD,IAAI,CAAC,aAAa,EAAE,CAAC;IACvB,CAAC;IACO,WAAW;QACjB,IAAI,CAAC,KAAK,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC;IAC3B,CAAC;IACO,aAAa;QACnB,IAAI,CAAC,aAAa,CAAC,aAAa,CAAC,IAAI,CAAC,UAAU,EAAE,CAAC,CAAC;IACtD,CAAC;IAED,UAAU;QACR,MAAM,WAAW,GAAG,IAAI,CAAC,UAAU,CAAC,IAAI,KAAK,SAAS,CAAC,QAAQ,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC;QAC1E,OAAO;YACL,KAAK,EAAE,IAAI,CAAC,iBAAiB,CAAC,IAAI,CAAC,QAAQ,CAAC;YAC5C,UAAU,EAAE,eAAa,CAAC,kBAAkB,CAAC,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC;YACpE,WAAW,EAAE,IAAI,CAAC,kBAAkB,CAClC,IAAI,CAAC,YAAY,CAAC,KAAK,GAAG,WAAW,CACtC;YACD,YAAY,EAAE,IAAI,CAAC,kBAAkB,CAAC,IAAI,CAAC,cAAc,EAAE,CAAC;YAC5D,WAAW,EAAE,IAAI,CAAC,kBAAkB,CAAC,IAAI,CAAC,aAAa,EAAE,CAAC;YAC1D,IAAI,EAAE,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;SACrC,CAAC;IACJ,CAAC;IACD,iBAAiB,CAAC,KAAa;QAC7B,OAAO,IAAI,CAAC,KAAK,CAAC,KAAK,GAAG,SAAS,CAAC,CAAC;IACvC,CAAC;IACD,kBAAkB,CAAC,KAAa;QAC9B,OAAO,IAAI,CAAC,KAAK,CAAC,KAAK,GAAG,UAAU,CAAC,CAAC;IACxC,CAAC;IAED,cAAc;QACZ,QAAQ,IAAI,CAAC,UAAU,CAAC,MAAM,EAAE;YAC9B,KAAK,WAAW,CAAC,EAAE;gBACjB,OAAO,GAAG,CAAC;YACb,KAAK,WAAW,CAAC,IAAI;gBACnB,OAAO,CAAC,CAAC;YACX,KAAK,WAAW,CAAC,GAAG;gBAClB,OAAO,CAAC,CAAC;SACZ;IACH,CAAC;IACD,aAAa;QACX,QAAQ,IAAI,CAAC,UAAU,CAAC,MAAM,EAAE;YAC9B,KAAK,WAAW,CAAC,EAAE,CAAC;YACpB,KAAK,WAAW,CAAC,IAAI;gBACnB,IAAI,IAAI,CAAC,YAAY,CAAC,IAAI,KAAK,SAAS,CAAC,KAAK,EAAE;oBAC9C,OAAO,CAAC,CAAC;iBACV;gBACD,OAAO,GAAG,CAAC;YACb,KAAK,WAAW,CAAC,GAAG;gBAClB,OAAO,CAAC,CAAC;SACZ;IACH,CAAC;IAED,MAAM,CAAC,kBAAkB,CAAC,IAAe;QACvC,6CAA6C;QAC7C,QAAQ,IAAI,EAAE;YACZ,KAAK,SAAS,CAAC,IAAI;gBACjB,OAAO,KAAK,CAAC,eAAe,CAAC,SAAS,CAAC,IAAI,CAAC;YAC9C,KAAK,SAAS,CAAC,KAAK;gBAClB,OAAO,KAAK,CAAC,eAAe,CAAC,SAAS,CAAC,KAAK,CAAC;YAC/C,KAAK,SAAS,CAAC,OAAO;gBACpB,OAAO,KAAK,CAAC,eAAe,CAAC,SAAS,CAAC,OAAO,CAAC;YACjD,KAAK,SAAS,CAAC,OAAO;gBACpB,OAAO,KAAK,CAAC,eAAe,CAAC,SAAS,CAAC,OAAO,CAAC;YACjD;gBACE,MAAM,IAAI,KAAK,CAAC,oBAAoB,CAAC,CAAC;SACzC;IACH,CAAC;CACF,CAAA;AA9KC;IADC,QAAQ,CAAC,EAAE,IAAI,EAAE,MAAM,EAAE,SAAS,EAAE,KAAK,EAAE,CAAC;gDACV;AAGnC;IADC,KAAK,EAAE;+CACqB;AAG7B;IADC,KAAK,EAAE;mDACgE;AAGxE;IADC,KAAK,EAAE;iDAKN;AAEF;IADC,KAAK,EAAE;4CACuB;AAjBpB,aAAa;IADzB,aAAa,CAAC,gBAAgB,CAAC;GACnB,aAAa,CAgLzB;SAhLY,aAAa;AAkL1B,MAAM,UAAU,GAAG,KAAK,CAAC;AACzB,MAAM,SAAS,GAAG,KAAK,CAAC","sourcesContent":["import * as flatbuffers from 'flatbuffers';\nimport { LitElement, PropertyValues, css, html } from 'lit';\nimport { customElement, property, state } from 'lit/decorators.js';\n\nimport { Willa } from './serialization';\nimport { MotorControl, MotorMode } from './motor';\nimport { SteeringChange, DriveSteering } from './steering';\nimport './motor';\nimport './steering';\nimport './board';\nimport settings from './settings';\nimport { BoardState, DriveMode, LightsState } from './board';\n\nexport interface DriveCommand {\n  steer: number;\n  motor_mode: Willa.DriveController.MotorMode;\n  motor_power: number;\n  front_lights: number;\n  rear_lights: number;\n  horn: number;\n}\n\nexport class DriveCommandSender {\n  private recurringCommand: number | null = null;\n  private webSocket: WebSocket | null = null;\n  private command: DriveCommand = {\n    steer: 0,\n    motor_mode: Willa.DriveController.MotorMode.Idle,\n    motor_power: 0,\n    front_lights: 0,\n    rear_lights: 0,\n    horn: 0,\n  };\n\n  enable(webSocket: WebSocket): void {\n    this.webSocket = webSocket;\n    this.disable();\n    this.recurringCommand = window.setInterval(\n      this.sendCommand,\n      settings.sendCommandIntervalMillis\n    );\n  }\n\n  disable(): void {\n    if (this.recurringCommand !== null) {\n      clearTimeout(this.recurringCommand!);\n    }\n  }\n  updateCommand(command: DriveCommand) {\n    this.command = command;\n  }\n\n  private serializeCommand(): Uint8Array {\n    const builder = new flatbuffers.Builder(100);\n    Willa.DriveController.DriveControl.startDriveControl(builder);\n    Willa.DriveController.DriveControl.addSteer(builder, this.command.steer);\n    Willa.DriveController.DriveControl.addMotorMode(\n      builder,\n      this.command.motor_mode\n    );\n    Willa.DriveController.DriveControl.addMotorPower(\n      builder,\n      this.command.motor_power\n    );\n    Willa.DriveController.DriveControl.addFrontLights(\n      builder,\n      this.command.front_lights\n    );\n    Willa.DriveController.DriveControl.addRearLights(\n      builder,\n      this.command.rear_lights\n    );\n    Willa.DriveController.DriveControl.addHorn(builder, this.command.horn);\n    const endPos = Willa.DriveController.DriveControl.endDriveControl(builder);\n    builder.finish(endPos);\n    return builder.asUint8Array();\n  }\n\n  private sendCommand = (): void => {\n    if (this.webSocket === null) {\n      throw new Error('no websocket');\n    }\n    this.webSocket.send(this.serializeCommand());\n  };\n}\n\nexport interface ControllerState {\n  steering: SteeringChange;\n  motorControl: MotorControl;\n  board: BoardState;\n}\n\n@customElement('drive-controls')\nexport class DriveControls extends LitElement {\n  @property({ type: Object, attribute: false })\n  webSocket: WebSocket | null = null;\n\n  @state()\n  private steering: number = 0;\n\n  @state()\n  private motorControl: MotorControl = { mode: MotorMode.idle, power: 0 };\n\n  @state()\n  private boardState: BoardState = {\n    lights: LightsState.off,\n    horn: false,\n    mode: DriveMode.handling,\n  };\n  @state()\n  private debug: boolean = false;\n\n  private commandSender = new DriveCommandSender();\n\n  static get styles() {\n    return css`\n      :host {\n        height: 100vh;\n        width: 100vw;\n        overflow: hidden;\n        display: flex;\n        flex-direction: row;\n        align-items: stretch;\n      }\n      #left-panel {\n        display: flex;\n        flex-direction: column;\n        width: 40%;\n      }\n      #debug {\n        position: absolute;\n        left: 50%;\n        text-align: left;\n      }\n    `;\n  }\n\n  disconnectedCallback(): void {\n    super.disconnectedCallback();\n    this.commandSender.disable();\n  }\n\n  willUpdate(changedProperties: PropertyValues<this>) {\n    if (changedProperties.has('webSocket')) {\n      this.commandSender.disable();\n      if (this.webSocket !== null) {\n        this.commandSender.enable(this.webSocket);\n      }\n    }\n  }\n\n  private debugPanel() {\n    const converted = this.getCommand();\n    if (this.debug) {\n      return html` <pre id=\"debug\">\n\nmotor power: ${this.motorControl.power.toFixed(2)} (${converted.motor_power})\nmotor direction: ${this.motorControl.mode} (${converted.motor_mode})\nsteering: ${this.steering.toFixed(2)} (${converted.steer})\nlights: ${this.boardState\n          .lights} (${converted.front_lights}) (${converted.rear_lights})\nhorn: ${this.boardState.horn} (${converted.horn})\ndrive mode: ${DriveMode[this.boardState.mode]}\n      </pre\n      >`;\n    } else {\n      return null;\n    }\n  }\n\n  render() {\n    return html`\n      <div id=\"left-panel\">\n        ${this.debugPanel()}\n        <drive-steering\n          .current=${this.steering}\n          @change=${this.onSteeringChange}\n        ></drive-steering>\n        <control-board\n          ?debug=${this.debug}\n          @change=${this.onBoardChange}\n          @toggleDebug=${this.toggleDebug}\n        ></control-board>\n      </div>\n\n      <drive-motor\n        .current=${this.motorControl}\n        @change=${this.onMotorControlChange}\n      ></drive-motor>\n    `;\n  }\n  private onBoardChange(event: CustomEvent<BoardState>) {\n    this.boardState = event.detail as BoardState;\n    this.updateCommand();\n  }\n\n  private onSteeringChange(event: CustomEvent<SteeringChange>): void {\n    this.steering = (event.detail as SteeringChange).steering;\n    this.updateCommand();\n  }\n  private onMotorControlChange(event: CustomEvent<MotorControl>): void {\n    this.motorControl = event.detail as MotorControl;\n    this.updateCommand();\n  }\n  private toggleDebug(): void {\n    this.debug = !this.debug;\n  }\n  private updateCommand(): void {\n    this.commandSender.updateCommand(this.getCommand());\n  }\n\n  getCommand(): DriveCommand {\n    const powerAdjust = this.boardState.mode === DriveMode.handling ? 0.5 : 1;\n    return {\n      steer: this.to_short_fraction(this.steering),\n      motor_mode: DriveControls.serializeMotorMode(this.motorControl.mode),\n      motor_power: this.to_ushort_fraction(\n        this.motorControl.power * powerAdjust\n      ),\n      front_lights: this.to_ushort_fraction(this.getFrontLights()),\n      rear_lights: this.to_ushort_fraction(this.getRearLights()),\n      horn: this.boardState.horn ? 523 : 0,\n    };\n  }\n  to_short_fraction(value: number): number {\n    return Math.round(value * MAX_SHORT);\n  }\n  to_ushort_fraction(value: number): number {\n    return Math.round(value * MAX_USHORT);\n  }\n\n  getFrontLights(): number {\n    switch (this.boardState.lights) {\n      case LightsState.on:\n        return 0.4;\n      case LightsState.high:\n        return 1;\n      case LightsState.off:\n        return 0;\n    }\n  }\n  getRearLights(): number {\n    switch (this.boardState.lights) {\n      case LightsState.on:\n      case LightsState.high:\n        if (this.motorControl.mode === MotorMode.brake) {\n          return 1;\n        }\n        return 0.3;\n      case LightsState.off:\n        return 0;\n    }\n  }\n\n  static serializeMotorMode(mode: MotorMode): Willa.DriveController.MotorMode {\n    //TODO: this should go to the drive controls.\n    switch (mode) {\n      case MotorMode.idle:\n        return Willa.DriveController.MotorMode.Idle;\n      case MotorMode.brake:\n        return Willa.DriveController.MotorMode.Brake;\n      case MotorMode.forward:\n        return Willa.DriveController.MotorMode.Forward;\n      case MotorMode.reverse:\n        return Willa.DriveController.MotorMode.Reverse;\n      default:\n        throw new Error('unknown motor mode');\n    }\n  }\n}\n\nconst MAX_USHORT = 65535;\nconst MAX_SHORT = 32767;\n"]}